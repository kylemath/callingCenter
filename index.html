<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOTV Calling Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header .subtitle {
            color: #666;
            font-size: 16px;
        }

        .progress-bar {
            background: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .view-filters {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }
        .filter-label { font-size: 12px; color: #6b7280; }
        .filter-btn {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            cursor: pointer;
        }
        .filter-btn.active {
            background: #667eea; color: #fff; border-color: #667eea;
        }

        .call-modes {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .mode-label { font-size: 12px; color: #6b7280; }
        .mode-btn { @apply .filter-btn; }
        .mode-btn { padding: 8px 10px; border-radius: 8px; border: 1px solid #e5e7eb; background: #f9fafb; color: #374151; font-weight: 600; cursor: pointer; }
        .mode-btn.active { background: #10b981; color: #fff; border-color: #10b981; }

        .caller-name {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        .caller-input {
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            width: 220px;
            font-size: 14px;
        }

        .title-buttons { display:flex; gap:8px; align-items:center; margin-top:8px; }
        .title-label { font-size: 12px; color:#6b7280; }
        .title-btn { padding: 6px 10px; border-radius:8px; border:1px solid #e5e7eb; background:#f9fafb; color:#374151; font-weight:600; cursor:pointer; }
        .title-btn.active { background:#f59e0b; color:#fff; border-color:#f59e0b; }

        .script-card {
            background: #fff7ed;
            border-left: 4px solid #fb923c;
            padding: 16px;
            border-radius: 10px;
            margin-top: 8px;
        }
        .script-card h3 { font-size: 16px; color: #9a3412; margin-bottom: 8px; }
        .script-card p { margin: 8px 0; color: #7c2d12; }
        .script-small { color: #9a3412; font-size: 12px; margin-top: 6px; }

        /* QR modal */
        .qr-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .qr-card { background: #ffffff; padding: 20px; border-radius: 12px; width: 340px; max-width: 92vw; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .qr-title { font-weight: 700; color: #111827; margin-bottom: 8px; }
        .qr-sub { color: #6b7280; font-size: 13px; margin-bottom: 10px; }
        .qr-img { width: 280px; height: 280px; border-radius: 8px; background: #f3f4f6; }
        .qr-close { margin-top: 12px; padding: 10px 12px; border: none; border-radius: 8px; background: #111827; color: #fff; font-weight: 600; cursor: pointer; }

        .progress-track {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .contact-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .contact-number {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .contact-name {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .info-grid {
            display: grid;
            gap: 25px;
            margin-bottom: 30px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .info-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }

        .info-content {
            flex: 1;
        }

        .info-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            color: #333;
            font-weight: 500;
            word-break: break-word;
        }

        .info-value.phone {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
        }

        .polling-info {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .polling-info .ward-district {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .polling-info .badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .lookup-link {
            display: inline-block;
            margin-top: 10px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .lookup-link:hover {
            text-decoration: underline;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .call-button {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(72, 198, 239, 0.4);
        }

        .call-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 198, 239, 0.5);
        }

        .call-button:active {
            transform: translateY(0);
        }

        .status-button {
            padding: 18px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4);
        }

        .btn-callback {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);
        }

        .btn-callback:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(250, 112, 154, 0.4);
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .nav-button {
            flex: 1;
            padding: 15px;
            border: 2px solid white;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Inline polling lookup */
        .lookup-wrapper {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-top: 16px;
        }

        .lookup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .lookup-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .lookup-actions {
            display: flex;
            gap: 10px;
        }

        .lookup-toggle,
        .lookup-open-link {
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            background: #667eea;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .lookup-open-link {
            background: #4a5568;
        }

        .lookup-results {
            display: none;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9ff;
            padding: 12px;
        }
        .lookup-loading { font-size: 14px; color: #6b7280; }
        .lookup-table { width: 100%; border-collapse: collapse; }
        .lookup-table th { text-align: left; font-weight: 600; padding: 6px 8px; color: #374151; }
        .lookup-table td { padding: 6px 8px; color: #111827; }
        .lookup-table tr { border-bottom: 1px solid #e5e7eb; }
        .map-embed { width: 100%; height: 320px; border: 0; border-radius: 6px; margin-top: 8px; }

        .stats-summary {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .stat-item {
            padding: 10px;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state h2 {
            font-size: 32px;
            margin-bottom: 15px;
        }

        .empty-state p {
            font-size: 18px;
            opacity: 0.9;
        }

        @media (max-width: 600px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .contact-name {
                font-size: 28px;
            }
            
            .info-value.phone {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è GOTV Calling Center</h1>
            <div class="subtitle">Election Day GOTV - Get Out The Vote</div>
        </div>

        <div class="progress-bar">
            <div class="progress-stats">
                <span>Progress</span>
                <span id="progress-text">0 / 100</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="view-filters">
                <span class="filter-label">View:</span>
                <button class="filter-btn active" id="filter-all" onclick="setFilter('all')">All</button>
                <button class="filter-btn" id="filter-remaining" onclick="setFilter('remaining')">Hide Completed</button>
                <button class="filter-btn" id="filter-callback" onclick="setFilter('callback')">Callbacks Only</button>
            </div>
            <div class="call-modes">
                <span class="mode-label">Call Mode:</span>
                <button class="mode-btn" id="mode-normal" onclick="setCallMode('normal')">Normal</button>
                <button class="mode-btn active" id="mode-private-67" onclick="setCallMode('private_67')">Private (*67)</button>
                <button class="mode-btn" id="mode-private-31" onclick="setCallMode('#31#')">Private (#31#)</button>
            </div>
            <div class="caller-name">
                <span class="mode-label">Your Name for Script:</span>
                <input id="caller-name-input" class="caller-input" placeholder="e.g., Your Name" />
            </div>
            <div class="title-buttons">
                <span class="title-label">Voter Title:</span>
                <button class="title-btn active" id="title-mr" onclick="setCallTitle('Mr.')">Mr.</button>
                <button class="title-btn" id="title-ms" onclick="setCallTitle('Ms.')">Ms.</button>
                <button class="title-btn" id="title-mx" onclick="setCallTitle('Mx.')">Mx.</button>
            </div>
        </div>

        <div id="contact-display"></div>

        <div class="stats-summary" id="stats-summary">
            <div class="stat-item">
                <div class="stat-number" id="stat-completed">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="stat-callback">0</div>
                <div class="stat-label">Callback</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="stat-remaining">100</div>
                <div class="stat-label">Remaining</div>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        let currentIndex = 0;
        let callStatus = {}; // Store status for each contact {id: 'completed'|'callback'}
        let filterMode = 'all'; // 'all' | 'remaining' | 'callback'
        let callMode = 'private_67'; // 'normal' | 'private_67' | '#31#'
        let callerName = '';
        let callTitle = 'Mr.'; // 'Mr.' | 'Ms.' | 'Mx.'
        
        // Load saved progress from localStorage
        function loadProgress() {
            const saved = localStorage.getItem('gotv-progress');
            if (saved) {
                const data = JSON.parse(saved);
                currentIndex = data.currentIndex || 0;
                callStatus = data.callStatus || {};
                filterMode = data.filterMode || 'all';
                applyFilterButtons();
                callMode = data.callMode || 'private_67';
                applyCallModeButtons();
                callerName = data.callerName || '';
                const nameInput = document.getElementById('caller-name-input');
                if (nameInput) nameInput.value = callerName;
                callTitle = data.callTitle || 'Mr.';
                applyTitleButtons();
            }
        }
        
        // Save progress to localStorage
        function saveProgress() {
            const payload = {
                currentIndex,
                callStatus,
                filterMode,
                callMode,
                callerName,
                callTitle,
                savedAt: new Date().toISOString(),
                version: 1
            };
            try {
                localStorage.setItem('gotv-progress', JSON.stringify(payload));
                // Redundant backup key in case the primary gets overwritten
                localStorage.setItem('gotv-progress-backup', JSON.stringify(payload));
            } catch (_) {}
        }

        let autosaveIntervalId = null;
        function startAutosave() {
            if (autosaveIntervalId) clearInterval(autosaveIntervalId);
            autosaveIntervalId = setInterval(saveProgress, 3000); // every 3s
        }
        
        // Update statistics
        function updateStats() {
            const completed = Object.values(callStatus).filter(s => s === 'completed').length;
            const callback = Object.values(callStatus).filter(s => s === 'callback').length;
            const remaining = contacts.length - completed - callback;
            
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-callback').textContent = callback;
            document.getElementById('stat-remaining').textContent = remaining;
            
            const progressPercent = ((completed + callback) / contacts.length * 100).toFixed(0);
            document.getElementById('progress-text').textContent = `${completed + callback} / ${contacts.length}`;
            document.getElementById('progress-fill').style.width = progressPercent + '%';
        }
        
        // Display current contact
        function displayContact() {
            if (contacts.length === 0) return;

            // Ensure currentIndex points to a contact that passes filter, else advance
            let safety = 0;
            while (!passesFilter(contacts[currentIndex]) && safety < contacts.length) {
                currentIndex = (currentIndex + 1) % contacts.length;
                safety++;
            }

            const anyVisible = contacts.some(c => passesFilter(c));
            if (!anyVisible) {
                document.getElementById('contact-display').innerHTML = `
                    <div class="empty-state">
                        <h2>No contacts match this view.</h2>
                        <p>Try switching filters above.</p>
                    </div>
                `;
                updateStats();
                saveProgress();
                return;
            }

            if (currentIndex >= contacts.length) {
                // All contacts processed
                document.getElementById('contact-display').innerHTML = `
                    <div class="empty-state">
                        <h2>üéâ All Contacts Processed!</h2>
                        <p>Great work! You've completed the calling list.</p>
                        <div style="margin-top:12px; display:flex; gap:10px; justify-content:center;">
                            <button class="nav-button" onclick="setFilter('callback')">Callbacks Only</button>
                            <button class="nav-button" onclick="resetAndRestart()">Start Over</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            const contact = contacts[currentIndex];
            const status = callStatus[contact.id];
            
            // Determine polling station display
            let pollingHTML = '';
            if (contact.ward || contact.district) {
                pollingHTML = `
                    <div class="info-item">
                        <div class="info-icon">üìç</div>
                        <div class="info-content">
                            <div class="info-label">Polling Station Info</div>
                            <div class="polling-info">
                                <div class="info-value">
                                    ${contact.ward ? `Ward: ${contact.ward}` : ''}
                                    ${contact.ward && contact.district ? ' | ' : ''}
                                    ${contact.district ? `District: ${contact.district}` : ''}
                                </div>
                                <a href="https://www.edmonton.ca/city_government/municipal_elections/for-voters" 
                                   target="_blank" class="lookup-link">
                                   Look up exact polling location ‚Üí
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            } else if (contact.address !== 'N/A') {
                pollingHTML = `
                    <div class="info-item">
                        <div class="info-icon">üìç</div>
                        <div class="info-content">
                            <div class="info-label">Polling Station</div>
                            <div class="polling-info">
                                <div class="info-value" style="font-size: 14px;">
                                    Polling station not pre-loaded for this contact
                                </div>
                                <a href="https://www.edmonton.ca/city_government/municipal_elections/for-voters?address=${encodeURIComponent(contact.address)}" 
                                   target="_blank" class="lookup-link">
                                   Look up polling station for ${contact.address} ‚Üí
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('contact-display').innerHTML = `
                <div class="contact-card">
                    <div class="contact-number">Contact ${currentIndex + 1} of ${contacts.length}</div>
                    <div class="contact-name">${contact.name}</div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-icon">üìû</div>
                            <div class="info-content">
                                <div class="info-label">Phone Number</div>
                                <div class="info-value phone">${contact.phone}</div>
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-icon">üè†</div>
                            <div class="info-content">
                                <div class="info-label">Address</div>
                                <div class="info-value">${contact.address}</div>
                            </div>
                        </div>
                        
                        ${pollingHTML}
                    </div>
                    
                    <div class="action-buttons">
                        <button class="status-button" style="background:#111827;color:#fff;" onclick="showDialQR('${contact.phone}')">üì∑ Dial QR</button>
                        <button class="status-button btn-success" onclick="markStatus('completed')">
                            ‚úÖ Got Through & Reminded
                        </button>
                        
                        <button class="status-button btn-callback" onclick="markStatus('callback')">
                            üîÑ Call Back Later
                        </button>
                    </div>

                    <div class="script-card" id="call-script"></div>

                    <div class="qr-overlay" id="qr-overlay">
                        <div class="qr-card">
                            <div class="qr-title">Scan to Dial</div>
                            <div class="qr-sub">Open your Pixel camera, point at the QR to dial with your current call mode.</div>
                            <img id="qr-img" class="qr-img" alt="Dial QR" />
                            <button class="qr-close" onclick="hideDialQR()">Close</button>
                        </div>
                    </div>

                    <div class="lookup-wrapper">
                        <div class="lookup-header">
                            <div class="lookup-title">Polling station lookup (City of Edmonton)</div>
                            <div class="lookup-actions">
                                <button class="lookup-toggle" onclick="lookupInline()">Find Inline</button>
                                <a class="lookup-open-link" id="lookup-external" href="#" target="_blank" rel="noopener">Open in New Tab</a>
                            </div>
                        </div>
                        <div class="lookup-results" id="lookup-results"></div>
                        <div style="margin-top:8px; color:#6b7280; font-size:13px;">
                            If inline lookup fails, use "Open in New Tab".
                        </div>
                    </div>
                </div>
                
                <div class="nav-buttons">
                    <button class="nav-button" onclick="previousContact()">
                        ‚Üê Previous
                    </button>
                    <button class="nav-button" onclick="nextContact()">
                        Next ‚Üí
                    </button>
                </div>
            `;
            
            updateStats();
            saveProgress();
            // Reset and wire polling lookup controls for this contact
            try {
                const external = document.getElementById('lookup-external');
                if (external) external.href = buildEdmontonLookupUrl();
                const results = document.getElementById('lookup-results');
                if (results) { results.style.display = 'none'; results.innerHTML = ''; }
                renderCallScript();
                // Auto-show QR dial card for current contact
                if (typeof showDialQR === 'function') { showDialQR(contact.phone); }
            } catch (_) {}
        }
        
        // Make a call
        function makeCall(phoneNumber) {
            // Clean the phone number
            const cleanNumber = phoneNumber.replace(/[^0-9]/g, '');
            
            // Note: *67 prefix for caller ID blocking works when dialing from phone
            // but may not work universally via tel: protocol
            let prefix = '';
            if (callMode === 'private_67') prefix = '*67';
            else if (callMode === '#31#') prefix = '#31#';
            else prefix = '';
            window.location.href = `tel:${prefix}${cleanNumber}`;
        }

        function copyNumber(phoneNumber) {
            const cleanNumber = phoneNumber.replace(/[^0-9]/g, '');
            const formatted = cleanNumber;
            navigator.clipboard.writeText(formatted).then(() => {
                // no-op
            });
        }

        function callViaZoom(phoneNumber) {
            const cleanNumber = phoneNumber.replace(/[^0-9]/g, '');
            const candidates = [
                `zoomphone://call?number=${cleanNumber}`,
                `zoomus://phonecall?number=${cleanNumber}`,
                `zoomus://call?number=${cleanNumber}`
            ];
            let tried = 0;
            const tryNext = () => {
                if (tried >= candidates.length) {
                    // Fallback to native dialer if Zoom Phone deep link isn't handled
                    makeCall(phoneNumber);
                    return;
                }
                const url = candidates[tried++];
                const before = Date.now();
                window.location.href = url;
                setTimeout(() => {
                    // If app wasn't opened, attempt next scheme
                    const elapsed = Date.now() - before;
                    if (!document.hidden && elapsed < 1200) {
                        tryNext();
                    }
                }, 800);
            };
            tryNext();
        }

        function showDialQR(phoneNumber) {
            const clean = phoneNumber.replace(/[^0-9]/g, '');
            let prefix = '';
            if (callMode === 'private_67') prefix = '*67';
            else if (callMode === '#31#') prefix = '#31#';
            const tel = `tel:${prefix}${clean}`;
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(tel)}`;
            const img = document.getElementById('qr-img');
            const overlay = document.getElementById('qr-overlay');
            if (img && overlay) {
                img.src = url;
                overlay.style.display = 'flex';
            }
        }

        function hideDialQR() {
            const overlay = document.getElementById('qr-overlay');
            if (overlay) overlay.style.display = 'none';
        }

        function buildEdmontonLookupUrl() {
            const contact = contacts[currentIndex];
            const base = 'https://www.edmonton.ca/city_government/municipal_elections/for-voters';
            const addr = contact && contact.address && contact.address !== 'N/A' ? `?address=${encodeURIComponent(contact.address)}` : '';
            return `${base}${addr}`;
        }

        async function lookupInline() {
            const results = document.getElementById('lookup-results');
            if (!results) return;
            results.style.display = 'block';
            results.innerHTML = `<div class="lookup-loading">Looking up polling station‚Ä¶</div>`;

            const contact = contacts[currentIndex];
            if (!contact || !contact.address || contact.address === 'N/A') {
                results.innerHTML = `<div class="lookup-loading">No address on file for this contact. Use the external link instead.</div>`;
                return;
            }

            try {
                // 1) Geocode via OpenStreetMap Nominatim (no key needed)
                const q = encodeURIComponent(`${contact.address}, Edmonton, AB, Canada`);
                const geoResp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`, {
                    headers: { 'Accept': 'application/json' }
                });
                const geo = await geoResp.json();
                if (!Array.isArray(geo) || geo.length === 0) throw new Error('Address not found');
                const lat = geo[0].lat;
                const lon = geo[0].lon;

                // 2) Query City of Edmonton open data for voting station intersecting this point
                const soql = `SELECT voting_station_number, voting_station_name, voting_station_descr, voting_station_address, adv_voting_station_number, adv_voting_station_descr, adv_voting_station_address, ward, public_school_ward, catholic_school_ward, geometry_multipolygon WHERE intersects(geometry_multipolygon, 'POINT(${lon} ${lat})')`;
                const edUrl = `https://data.edmonton.ca/resource/8iqj-cpxk.json?$query=${encodeURIComponent(soql)}&$$app_token=0oJXDgD03EhFesr9YRJVhneSv`;
                const edResp = await fetch(edUrl, { headers: { 'Accept': 'application/json' } });
                const data = await edResp.json();
                if (!Array.isArray(data) || data.length === 0) throw new Error('No station found');
                const s = data[0];

                const advSection = (s.adv_voting_station_number && s.adv_voting_station_address) ? `
                    <tr><th colspan="2" style="padding-top:8px;">Advance Voting</th></tr>
                    <tr><th>Building</th><td>${s.adv_voting_station_descr || 'N/A'}</td></tr>
                    <tr><th>Address</th><td><a target="_blank" href="${'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(s.adv_voting_station_address)}">${s.adv_voting_station_address}</a></td></tr>
                    <tr><th>Station</th><td>${s.adv_voting_station_number}</td></tr>
                ` : '';

                const mapEmbed = `<iframe class="map-embed" src="https://www.google.com/maps?q=${encodeURIComponent(s.voting_station_address || contact.address)}&output=embed" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;

                results.innerHTML = `
                    <table class="lookup-table">
                        <tr><th>Ward</th><td>${s.ward || ''}</td></tr>
                        <tr><th>Building</th><td>${s.voting_station_descr || ''}</td></tr>
                        <tr><th>Address</th><td><a target="_blank" href="${'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(s.voting_station_address)}">${s.voting_station_address || ''}</a></td></tr>
                        <tr><th>Station</th><td>${s.voting_station_number || ''}</td></tr>
                        <tr><th>Hours</th><td>9am ‚Äì 8pm (Election Day)</td></tr>
                        <tr><th>Public School</th><td>${s.public_school_ward || ''}</td></tr>
                        <tr><th>Catholic School</th><td>${s.catholic_school_ward || ''}</td></tr>
                        ${advSection}
                    </table>
                    ${mapEmbed}
                `;
            } catch (err) {
                results.innerHTML = `<div class="lookup-loading">Inline lookup failed: ${err.message}. Use the external link instead.</div>`;
            }
        }

        // Script rendering using Instructions.md content, personalized
        function getFirstName(name) {
            if (!name) return '';
            const cleaned = name.trim().split(/[\s,]+/)[0];
            return cleaned.charAt(0).toUpperCase() + cleaned.slice(1).toLowerCase();
        }

        function getSurname(name) {
            if (!name) return '';
            const parts = name.trim().split(/[\s,]+/).filter(Boolean);
            if (parts.length === 0) return '';
            const last = parts[parts.length - 1];
            return last.charAt(0).toUpperCase() + last.slice(1).toLowerCase();
        }

        function renderCallScript() {
            const el = document.getElementById('call-script');
            if (!el) return;
            const contact = contacts[currentIndex];
            const voterName = getFirstName(contact?.name || '');
            const voterSurname = getSurname(contact?.name || '');
            const myName = callerName || '‚Äî';
            const votersUrl = buildEdmontonLookupUrl();
            el.innerHTML = `
                <h3>Suggested Script</h3>
                <p>Hi ${voterSurname ? `${callTitle} <strong>${voterSurname}</strong>` : (voterName || 'there')}, my name is <strong>${myName}</strong>, and I'm a volunteer with the campaign. I'm calling because it's Election Day today.</p>
                <p>Have you had a chance to vote yet?</p>
                <p><em>If Yes</em>: That's fantastic! Thank you so much for taking the time to vote. Every vote makes a difference today.</p>
                <p><em>If No</em>: No problem ‚Äî polls are open until 8pm. Do you know where your polling station is?</p>
                <p><em>If unsure</em>: No worries, I can help you find it right now: <a href="${votersUrl}" target="_blank" rel="noopener">edmonton.ca/election</a>.</p>
                <p>Do you need a ride or any help getting to your polling station today? We have volunteers available to assist.</p>
                <p>We just need every supporter to get out and vote today. Can we count on you to make it to the polls before they close?</p>
                <p class="script-small">Tip: Use the buttons above to log this call and the lookup panel below for polling details.</p>
            `;
        }

        function applyTitleButtons() {
            ['title-mr','title-ms','title-mx'].forEach(id => { const el = document.getElementById(id); if (el) el.classList.remove('active'); });
            const activeId = callTitle === 'Mr.' ? 'title-mr' : callTitle === 'Ms.' ? 'title-ms' : 'title-mx';
            const activeEl = document.getElementById(activeId); if (activeEl) activeEl.classList.add('active');
        }

        function setCallTitle(title) {
            callTitle = title;
            applyTitleButtons();
            saveProgress();
            renderCallScript();
        }

        // Filtering & navigation helpers
        function passesFilter(contact) {
            const status = callStatus[contact.id];
            if (filterMode === 'all') return true;
            if (filterMode === 'remaining') return status !== 'completed';
            if (filterMode === 'callback') return status === 'callback';
            return true;
        }

        function setFilter(mode) {
            filterMode = mode;
            applyFilterButtons();
            // Move to the first contact that matches the filter
            let idx = 0;
            let found = false;
            for (let i = 0; i < contacts.length; i++) {
                if (passesFilter(contacts[i])) { idx = i; found = true; break; }
            }
            if (found) currentIndex = idx;
            saveProgress();
            displayContact();
        }

        function applyFilterButtons() {
            const ids = ['filter-all','filter-remaining','filter-callback'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.classList.remove('active'); });
            const activeId = filterMode === 'all' ? 'filter-all' : (filterMode === 'remaining' ? 'filter-remaining' : 'filter-callback');
            const activeEl = document.getElementById(activeId); if (activeEl) activeEl.classList.add('active');
        }

        function applyCallModeButtons() {
            const ids = ['mode-normal','mode-private-67','mode-private-31'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.classList.remove('active'); });
            const activeId = callMode === 'normal' ? 'mode-normal' : (callMode === 'private_67' ? 'mode-private-67' : 'mode-private-31');
            const activeEl = document.getElementById(activeId); if (activeEl) activeEl.classList.add('active');
        }

        function setCallMode(mode) {
            callMode = mode;
            applyCallModeButtons();
            saveProgress();
        }

        function findNextIndex(start, step) {
            let i = start;
            for (let hop = 0; hop < contacts.length; hop++) {
                if (i < 0) i = contacts.length - 1;
                if (i >= contacts.length) i = 0;
                if (passesFilter(contacts[i])) return i;
                i += step;
            }
            return start; // fallback
        }
        
        // Mark contact status and move to next
        function markStatus(status) {
            const contact = contacts[currentIndex];
            callStatus[contact.id] = status;
            saveProgress();
            nextContact();
        }
        
        // Navigation
        function nextContact() {
            currentIndex = findNextIndex(currentIndex + 1, +1);
            displayContact();
        }
        
        function previousContact() {
            currentIndex = findNextIndex(currentIndex - 1, -1);
            displayContact();
        }
        
        function resetAndRestart() {
            if (confirm('Are you sure you want to reset all progress and start over?')) {
                currentIndex = 0;
                callStatus = {};
                saveProgress();
                displayContact();
            }
        }
        
        // Initialize
        loadProgress();
        displayContact();
        startAutosave();
        // Save when tab/window is hidden or closed
        document.addEventListener('visibilitychange', () => { if (document.hidden) saveProgress(); });
        window.addEventListener('beforeunload', saveProgress);

        const nameInputEl = document.getElementById('caller-name-input');
        if (nameInputEl) {
            nameInputEl.addEventListener('input', (e) => {
                callerName = e.target.value || '';
                saveProgress();
                renderCallScript();
            });
        }
    </script>
</body>
</html>

